# 项目初始化 (agent.md)

## 设计原则

- 前后端分离
- 鉴权统一使用 Supabase
- 数据库初版 DDL 文件放置在根目录 `mcp.ddl`

## 开发环境

- Maven 路径：`~/dev`（使用该目录下的 `mvn`）
- Maven 仓库：阿里云仓库（项目内 `backend/pom.xml` 已配置）
- 前端目录：`web/`
- 前端 API 基址：`VITE_API_BASE_URL`（根目录 `.env`）
- Mock 方式：外围交互由后端 mock（企查查、提醒、异常对账）
- 数据库相关接口必须直连数据库（如主体、合同、财务），不得使用 mock
- 数据库维护脚本：根目录 `db/`
  - DDL：`db/mcp.ddl`
  - DML：`db/mcp.dml`

## 运行与联调

- 后端启动：`~/dev/apache-maven-3.9.12/bin/mvn -f backend/pom.xml spring-boot:run`
- 前端启动：
  - `cd web`
  - `npm run dev -- --host`

## 测试文档要求

- 目录：`docs/manuals/`
- 命名：`<功能>测试手册.md`
- 格式：包含“前置 / 用例 / 预期结果 / 常见问题排查”（参考现有手册）
- 新增或更新手册时，不要写入 `README.md` 的正文，只在 README 的“测试手册”列表里注明
- 测试完成记录：`docs/manuals/<功能>测试完成记录.md`

## 关键 API（最小闭环 + mock）

- 合同：`POST /api/contracts`，`POST /api/contracts/{id}/submit`，`POST /api/contracts/{id}/confirm`
- 付款匹配：`GET /api/payments/matches?mgAccount=`
- 财务录入：`POST /api/finance/bank-transfers`
- 对账：`GET /api/reconciliation/unmatched`，`GET /api/reconciliation/mismatch`（mock）
- 提醒：`GET /api/reminders/unmatched`（mock）
- 主体：`GET /api/subjects/bank-history`，`GET /api/subjects/client`，`POST /api/subjects/verify`（mock）

## 基础业务要求

一、销售端合同录入功能

1、信息主体录入逻辑

1）公对公转账判断

a、要有一个选项，问销售是否公对公转账。

b、如果是，销售输入主体信息的时候，要在公对公转账的名单里查找，如果查找不到需要用户改写。

c、如果客户之前有历史公对公转账，就拉出历史转账主体，让销售选。

d、信息主体销售如果选择了已经有公对公转账，则不能进行自由输入。

2）非公对公转账逻辑

a、如果销售没有选公对公转账，且没有扫码付款，代表客户未付款。

b、此时销售优先从客户自己录入的公司主体里面选择一个。

c、如果没有本次合适的可以自由录入公司主体不需要校验公对公转账表，但是要校验企查查号，拉出完整信息。

3）通用规则与限制

a、主体信息部分页面含下拉和自由撰写，除了已经选择公对公转账的不能自由输入外，其余可以自由输入。

b、这里的逻辑是，有转账信息优先拉转账主体，所有的都要跟实际打款一致。没有转账信息，优先拉客户自己输入的主体。都没有才需要自由写。

4）相关提示与补充

a、提醒文案：该合同主体会用于打款和开发票，请确保此处主体与打款主体和发票主体一致，否则无法开票。

b、补充，此处有个收货地址，是指客户需要签纸板合同的时候，邮寄地址。

2、套餐金额与内容录入

1）金额匹配规则

a、如果匹配到扫码付款，则此处金额只能看不能改。

b、如果匹配到公对公转账，是要做选择确认的，有可能是多笔可以多选，不能自有撰写。

c、如果没有匹配到任何金额，销售可以下拉选择标准金额，也可以自己填一个金额。

2）套餐内容

a、套餐赠送内容，默认按照每个套餐的标准先拉好填好，都是可改项。

3、合同生成与流转

1）生成与预览

a、合同录入完成后，自动生成一个合同，可以预览。

b、合同里面的内容要加上musegate主账号名称和手机号。

2）审核与交付

a、点确认后，合同发送到顶级主管（甲第的下一级销售），主管确认，月清就可以打印合同，按地址邮寄（邮寄的时候塞一张寄回地址）。

4、付款校验与提醒机制

1）从扫码付款、公对公转账校验中确认客户已经付款的，需要每天给销售弹窗提醒录合同。

2）此处要做收款验证，公对公转账收到款后如果能严格匹配到某个历史打款账户及其对应的MG账号，就需要每天提醒销售录合同。

五、后台Muse点充值逻辑（自动逻辑）

1、扫码支付场景

1）扫码支付，这个就自动录入muse点。

2、公对公转账场景

1）销售在录入合同，能够正确匹配到一笔转账，则销售点确认后就立即充值。

2）如果客户已经转账，销售在录合同中找不到，说明销售写错了，此时合同录入不能完成，销售必须要完成一个匹配的转账。

六、财务录入与对账功能

1、财务录入功能

1）要做一个财务录入公对公打款金额的功能。

2、对账功能

1）场景描述：存在有款项，未与合同关联。

2）异常处理逻辑：

a、销售还未录合同。（每月跟销售leader对，查谁没有录合同）

b、销售录的合同写错了，要跟有合同但是没有匹配入账的合同进行人工对焦。。
